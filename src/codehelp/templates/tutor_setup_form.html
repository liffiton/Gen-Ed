{% extends "base.html" %}

{% block body %}
<section class="section">
  <div class="container">
    <h1 class="title">Tutor Setup</h1>
    <form class="wide-labels" method="post" x-data="{loading1: false, loading2: false}" x-on:pageshow.window="loading1 = loading2 = false" x-on:submit.debounce.10ms="if ($event.submitter.id === 'gen_objectives') {loading1 = true} else {loading2 = true}">
      <div class="field is-horizontal">
        <div class="field-label is-normal">
          <label class="label" for="context">Learning context</label>
          <p class="help-text">Briefly describe the class or other context.<br>E.g.: "A college CS 1 course using Python"</p>
        </div>
        <div class="field-body">
          <div class="field">
            <div class="control">
              <input class="input" name="context" id="context" x-bind:disabled="loading1 || loading2" required value="{{ tutorconf.context }}">
            </div>
          </div>
        </div>
      </div>

      <div class="field is-horizontal">
        <div class="field-label is-normal">
          <label class="label" for="topic">Topic</label>
        </div>
        <div class="field-body">
          <div class="field">
            <div class="control">
              <input class="input" name="topic" id="topic" x-bind:disabled="loading1 || loading2" required value="{{ tutorconf.topic }}">
            </div>
          </div>
        </div>
      </div>

      <div class="field is-horizontal">
        <div class="field-label is-normal"><!-- spacing --></div>
        <div class="field-body">
          <div class="field is-grouped">
            <div class="control">
              <button
                class="button {% if not tutorconf.objectives %}is-link{% else %}is-warning{% endif %}"
                type="submit"
                id="gen_objectives"
                x-bind:class="loading1 ? 'is-loading' : ''"
                x-bind:disabled="loading2"
                formaction="{{ url_for('tutors.config.generate_objectives') }}"
              >
                {% if tutorconf.objectives %}Regenerate{% else %}Generate{% endif %}
              </button>
            </div>
            <div class="control">
              <input name="num_objectives" class="input" type="number" size="1" value="5">
            </div>
            <div class="control pt-2">
              draft learning objectives.
              {% if tutorconf.objectives %}
                <span class="help-text ml-4 is-size-7 is-italic">This will overwrite existing objectives and questions.</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      {% if tutorconf.objectives %}
      <div class="field is-horizontal">
        <div class="field-label is-normal">
          <label class="label" for="objectives">Learning Objectives</label>
        </div>
        <div class="field-body">
          <div class="field">
            <div class="control">
              <textarea class="textarea" x-bind:disabled="loading1 || loading2" required name="objectives" id="objectives" rows="5">
                {%- for obj in tutorconf.objectives %}
                  {{- obj.name }}
                {% endfor -%}
              </textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="field is-horizontal">
        <div class="field-label is-normal"><!-- spacing --></div>
        <div class="field-body">
          <div class="field is-grouped">
            <div class="control">
              <button
                class="button {% if not has_questions %}is-link{% else %}is-warning{% endif %}"
                type="submit"
                id="gen_questions"
                x-bind:class="loading2 ? 'is-loading' : ''"
                x-bind:disabled="loading1"
                formaction="{{ url_for('tutors.config.generate_questions') }}"
              >
                {% if has_questions %}Regenerate{% else %}Generate{% endif %}
              </button>
            </div>
            <div class="control">
              <input name="num_questions" class="input" type="number" size="1" value="4">
            </div>
            <div class="control pt-2">
              draft questions per objective.
              {% if has_questions %}
                <span class="help-text ml-4 is-size-7 is-italic">This will overwrite existing questions.</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      {% if has_questions %}
      <div class="field is-horizontal">
        <div class="field-label is-normal"><!-- spacing --></div>
        <div class="field-body">
          <div class="content">
            <h2 class="is-size-5">Objectives &amp; Questions</h2>
            {% for obj in tutorconf.objectives %}
              <div class="box">
              <h3 class="is-size-6">{{ loop.index }}. {{ obj.name }}</h3>
              <ol>
                {% set obj_index = loop.index0 %}
                {% for question in obj.questions %}
                  <input type="hidden" name="questions[{{ obj_index }}]" value="{{ question }}">
                  <li class="mt-3">{{ question | markdown }}</li>
                {% endfor %}
              </ol>
              <button class="button is-link is-light ml-4" type="button" onclick="document.getElementById('dia_{{ loop.index }}').showModal()">
                Edit questions
              </button>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <div class="field is-horizontal mt-5">
        <div class="field-label is-normal"><!-- spacing --></div>
        <div class="field-body">
          <div class="field is-grouped">
            <div class="control">
              <button class="button is-link" type="submit" {% if not has_questions %}disabled{% endif %} formaction="{{ url_for('tutors.config.create_tutor') }}">
                Save Tutor
              </button>
            </div>
            <div class="control">
              <button class="button is-light" type="submit" formnovalidate formaction="{{ url_for('tutors.config.reset_setup') }}">
                Start Over
              </button>
            </div>
          </div>
        </div>
      </div>

      {% if tutorconf.objectives %}
      <div class="field is-horizontal">
        <div class="field-label is-normal"><!-- spacing --></div>
        <div class="field-body">
          <div class="notification is-warning">
            <strong>Note:</strong> Your work is not saved until all steps are complete and the tutor is created.
          </div>
        </div>
      </div>
      {% endif %}
    </form>

    {% if has_questions %}
      {% for obj in tutorconf.objectives %}
        <dialog id="dia_{{ loop.index }}" style="width: 50%; mind-width: min(32em, 100vw);">
          <div class="content box">
            <h3>{{ obj.name }}</h3>
            <form action="{{ url_for('tutors.config.update_questions') }}" method="post">
              <input type="hidden" name="obj_index" value="{{ loop.index0 }}">
              <div class="field">
                <div class="label">Questions</div>
                {% for question in obj.questions %}
                <div class="control mt-2">
                  <textarea class="textarea" style="height: fit-content;" name="questions[]">{{ question }}</textarea>
                </div>
                {% endfor %}
              </div>
              <div class="field is-grouped">
                <div class="control">
                  <button class="button is-link" type="submit">Update</button>
                </div>
                <div class="control">
                  <button class="button" type="reset" onclick="this.closest('dialog').close()">Cancel</button>
                </div>
              </div>
            </form>
          </div>
        </dialog>
      {% endfor %}
    {% endif %}

  </div>
</section>
{% endblock body %}
