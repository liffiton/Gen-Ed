{% with table=ctx.table, item_data=ctx.item_data, copyable_courses=ctx.copyable_courses %}
<div class="content">
  <h2 class="title is-size-4">{{ table.display_name_plural | title }}</h2>
  {% if table.help_text is string %}
    {{ table.help_text }}
  {% elif table.help_text is not none %}{# will be a jinja template object here #}
    {% include table.help_text %}
  {% endif %}
  <script type="text/javascript">
    function datePassed(date) {
      const now_datetime = new Date();  // automatically UTC
      const target_date = new Date(date);  // automatically UTC
      target_date.setHours(target_date.getHours() - 12);  // UTC-12 for anywhere on Earth
      return now_datetime >= target_date;
    }
    function formatDate(date) {
      // Add 'T00:00' to force parsing as local time so UTC-local shift doesn't change date
      return new Date(date + 'T00:00').toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
    }
    document.addEventListener('alpine:init', () => {
      Alpine.data('config_table_{{ table.name }}', () => ({
        items: {{ item_data | tojson }},
        drag_index: null,

        dragstart(index, event) {
          // only allow drag if over the drag handle td
          const dragElement = event.target.querySelector("[data-drag-handle]");
          // use :hover match to detect if cursor is within the element
          if (dragElement === null || !dragElement.matches(":hover")) { event.preventDefault(); return; }
          this.drag_index = index;
        },
        dragenter(index) {
          if (this.drag_index === null || index === this.drag_index) { return; }
          const draggedItem = this.items.splice(this.drag_index, 1)[0];
          this.items.splice(index, 0, draggedItem);
          this.drag_index = index;
        },
        dragend() {
          if (this.drag_index === null) { return; }
          this.drag_index = null;
          // post updated ordering to save in DB
          fetch("{{ url_for('class_config.table.crud.update_order', table_name=table.name) }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(this.items.map(item => item.id)),
          });
        },
      }));
      Alpine.data('available_dropdown_{{ table.name }}', (item) => ({
        // 'item': an item object passed in from the for loop in the parent Alpine scope ('config_table...')
        showDropdown: false,
        showModal: false,
        newDate: null,

        init() {
          this.$watch('item.available', newval => {
            // post updated date to save in DB
            fetch("{{ url_for('class_config.table.crud.update_available', table_name=table.name) }}", {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({'item_id': item.id, 'available': item.available}),
            });
          });
        },
        get status() { return item.available === '9999-12-31' ? 'Hidden' : datePassed(item.available) ? 'Now' : 'Scheduled'; },
        get min_date_str() { const min_date = new Date(); min_date.setDate(min_date.getDate() + 1); return min_date.toISOString().split('T')[0]; },
        chooseScheduled() {
          if (this.status === 'Scheduled') {
            this.newDate = item.available;
          }
          else {
            // get today in YYYY-MM-DD format as starting point for date picker
            this.newDate = this.min_date_str;
          }
          this.showModal = true;
        },
      }));
      Alpine.data('link_display', (link_url) => ({
        link_URL: link_url,
        copied: false,
        copy_url() {
          navigator.clipboard.writeText(this.link_URL);
          this.copied = true;
          setTimeout(() => {this.copied = false;}, 2000);
        },
      }));
    });
  </script>
  <table class="table is-hoverable is-narrow" style="width: auto; min-width: min(40em, 80%); margin: auto;" x-data="config_table_{{ table.name }}">
    <thead>
      <tr>
        <th class="p-0 has-text-centered has-text-grey" title="Reorder">
          <svg aria-hidden="true" class="icon is-small" style="vertical-align: bottom;"><use href="#svg_arrow_up_down" /></svg>
        </th>
        <th>
          Name
          <span class="has-text-weight-light has-text-grey ml-1"><small>click to edit</small></span>
        </th>
        <th class="has-text-centered">Available</th>
        <th class="has-text-centered has-text-grey"><small>actions</small></th>
      </tr>
    </thead>
    <tbody>
      <template x-for="(item, index) in items" x-bind:key="item.name">
        <tr draggable="true" @dragstart="dragstart(index, $event)" @dragend="dragend" @dragenter="dragenter(index)" x-bind:style="(drag_index == index) && {background: '#fc9'}">
          <td data-drag-handle style="cursor: move; vertical-align: middle; text-align: center;" title="drag to reorder">
            <svg aria-hidden="true" class="icon is-small mt-1"><use href="#svg_grip" /></svg>
          </td>
          <td style="vertical-align: middle;">
            <a class="hover-show-icon has-text-link-dark" style="text-decoration: none;" x-bind:title="`edit '${item.name}'`" x-bind:href="item.url_edit">
              <span class="is-underlined" x-text="item.name"></span>
              <svg aria-hidden="true" class="icon is-small has-text-link-dark"><use href="#svg_pencil" /></svg>
            </a>
          </td>
          <td style="text-align: center; vertical-align: middle;">
            <div x-data="available_dropdown_{{ table.name }}(item)">
              <div class="dropdown" x-bind:class="{'is-active': showDropdown}">
                <div class="dropdown-trigger">
                  <button class="button is-small is-rounded" style="white-space: normal;"
                    x-bind:class="{
                      'is-success': status === 'Now',
                      'is-warning': status === 'Scheduled',
                      'is-danger': status === 'Hidden',
                    }"
                    @click="showDropdown = !showDropdown"
                    @click.outside="showDropdown = false"
                    aria-haspopup="true" x-bind:aria-controls="`dropdown-menu${index}`">
                    <span x-text="status === 'Scheduled' ? `Scheduled: ${formatDate(item.available)}` : status"></span>
                    <svg aria-hidden="true" class="icon is-small"><use href="#svg_chevron_down" /></svg>
                  </button>
                </div>
                <div class="dropdown-menu" x-bind:id="`dropdown-menu${index}`" role="menu">
                  <div class="dropdown-content has-text-left">
                    <a href="#" class="dropdown-item" @click.prevent="item.available = '0001-01-01'">Now</a>
                    <a href="#" class="dropdown-item" @click.prevent="chooseScheduled">Scheduled</a>
                    <a href="#" class="dropdown-item" @click.prevent="item.available = '9999-12-31'">Hidden</a>
                  </div>
                </div>
              </div>
              <div class="modal" x-bind:class="{ 'is-active': showModal }" @keydown.escape.window="showModal = false">
                <div class="modal-background" @click="showModal = false"></div>
                <div class="modal-content">
                  <div class="box has-text-left">
                    <h3 class="title is-4">Schedule '<span x-text="item.name"></span>'</h3>
                    <p>When scheduled for a certain date, the {{ table.display_name }} becomes available when that date is reached anywhere on Earth (UTC+12).</p>
                    <form @submit.prevent="item.available = newDate; showModal = false">
                      <div class="field is-grouped" style="justify-content: center;">
                        <p class="control">
                          <input type="date" class="input is-large" x-model="newDate" x-bind:min="min_date_str">
                        </p>
                        <p class="control">
                          <button type="submit" class="button is-large is-link">OK</button>
                        </p>
                        <p class="control">
                          <button type="submit" @click.prevent="showModal = false" class="button is-large">Cancel</button>
                        </p>
                      </div>
                    </form>
                  </div>
                </div>
                <button type="button" class="modal-close is-large" aria-label="close" @click="showModal = false"></button>
              </div>
            </div>
          </td>
          <td class="has-text-centered">
            <form method="post">
              <span x-show="item.share_links.length > 0" x-data="{ showLinkModal: false }">
                <button x-bind:title="`link to '${item.name}'`" class="button is-white is-small has-text-grey" type="button" @click="showLinkModal = true">
                  <svg aria-hidden="true" class="icon is-small"><use href="#svg_link" /></svg>
                </button>
                <div class="modal" x-bind:class="{'is-active': showLinkModal}" @keydown.escape.window="showLinkModal = false;">
                  <div class="modal-background" @click="showLinkModal = false;"></div>
                  <div class="modal-content" style="width: clamp(min(50em, 100vw), 50vw, 100vw);">
                    <div class="box has-text-left">
                      <h3 class="title is-4">
                        <svg aria-hidden="true" class="icon"><use href="#svg_link" /></svg>
                        Link to '<span x-text="item.name"></span>'
                      </h3>
                      <p>Take your students directly to the '<span x-text="item.name"></span>' {{ table.display_name }} in {{ config['APPLICATION_TITLE'] }}:</p>
                      <template x-for="share_link in item.share_links">
                      <div class="field has-addons is-horizontal" x-data="link_display(share_link.url)">
                        <div class="field-label label is-normal" x-text="share_link.label"></div>
                        <div class="field-body" style="flex-grow: 5;">
                          <div class="control is-expanded">
                            <input class="input" readonly x-bind:value="link_URL">
                          </div>
                          <div class="control">
                            <button type="button" class="button icon-text" x-bind:class="copied ? 'is-success' : 'is-link'" @click="copy_url">
                              <svg aria-hidden="true" class="icon is-right"><use href="#svg_copy" /></svg>
                              <span x-text="copied ? 'copied' : 'copy'"></span>
                            </button>
                          </div>
                        </div>
                      </div>
                      </template>
                      <div class="notification content is-warning has-background-warning-light" style="font-size: 85%;">
                        <p>These links will let students access the {{ table.display_name }} even if it is currently hidden.</p>
                        {% if auth.user.auth_provider == 'lti' %}
                        <p>These links will <b>not</b> log a student in to the class:
                          <ul>
                            <li>Students must log in to {{ config['APPLICATION_TITLE'] }} via the main link from your LMS <strong>before</strong> they use one of these links.</li>
                          </ul>
                        </p>
                        {% else %}
                        <p>These links will <b>not</b> register a student in the class:
                          <ul>
                            <li>Students must have already joined this class <strong>before</strong> they use one of these links.</li>
                          </ul>
                        </p>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  <button type="button" class="modal-close is-large" aria-label="close" @click="showLinkModal = false;"></button>
                </div>
              </span>
              <button x-bind:title="`copy '${item.name}'`" class="button is-white is-small has-text-grey" type="submit" x-bind:formaction="item.url_copy">
                <svg aria-hidden="true" class="icon is-small"><use href="#svg_copy" /></svg>
              </button>
              <button x-bind:title="`delete '${item.name}'`" class="button is-white is-small has-text-danger" type="submit" x-bind:formaction="item.url_delete" @click="$event => confirm('Are you sure you want to delete \'' + item.name + '\'?') || $event.preventDefault()">
                <svg aria-hidden="true" class="icon is-small"><use href="#svg_trash" /></svg>
              </button>
            </form>
          </td>
        </tr>
      </template>
      <tr x-show="items.length == 0"><td colspan=4 class="has-text-centered"><i>No items defined.</i></td></tr>
      <tr x-show="items.length > 0 && items.every(item => !datePassed(item.available))"><td colspan=4 class="has-text-centered"><span class="tag is-warning"><strong>Warning</strong>: No {{ table.display_name_plural }} are currently available.</span></td></tr>
    </tbody>
  </table>
  <div class="mt-2 has-text-centered">
    <a class="button is-light is-link is-small" href="{{ table.new_url }}">
      <span class="icon">
        <svg aria-hidden="true"><use href="#svg_plus" /></svg>
      </span>
      <span>Create new {{ table.display_name }}</span>
    </a>

    {# Button and modal for copying items from another course #}
    <span x-data='{
        showCopyModal: false,
        courses_data: {{ copyable_courses | tojson }},
        selected_course_id: "",
        get selected_course() {
          return this.courses_data.find(course => course.id == this.selected_course_id) || {"id": null, "name": null, "items": []};
        }
      }'
      x-show="courses_data.length > 0">
      <button class="button is-light is-link is-small ml-2"
              @click="showCopyModal = true; selected_course_id = '';"
              title="Copy all items from another course you teach into this one">
        <span class="icon">
          <svg aria-hidden="true"><use href="#svg_copy" /></svg>
        </span>
        <span>Copy from another course...</span>
      </button>

      <div class="modal has-text-left" x-bind:class="{ 'is-active': showCopyModal }" @keydown.escape.window="showCopyModal = false">
        <div class="modal-background" @click="showCopyModal = false"></div>
        <div class="modal-content">
          <div class="box">
            <h3 class="title is-4">Copy {{ table.display_name_plural | title }}</h3>
            <p>Select a course to see its {{ table.display_name_plural }}. All items from the selected course will be copied into the current course. Existing items will not be affected, and copied items will be renamed if necessary to avoid duplicate names.</p>
            <form method="post" action="{{ url_for('class_config.table.crud.copy_from_course', table_name=table.name) }}">
              <div class="field">
                <label class="label" for="source_class_id">Copy from course:</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select name="source_class_id" id="source_class_id" required x-model="selected_course_id">
                      <option value="" disabled selected>-- Select a course --</option>
                      <template x-for="course in courses_data" :key="course.id">
                        <option :value="course.id" x-text="course.name"></option>
                      </template>
                    </select>
                  </div>
                </div>
              </div>

              {# Section to display items of the selected course #}
              <div class="mt-3 mb-3 content" style="min-height: 200px; max-height: 200px; overflow-y: auto; border: 1px solid #dbdbdb; padding: 0.5em;">
                <div x-show="selected_course.items.length > 0" class="m-0">
                  <p class="has-text-weight-semibold" x-text="`{{ table.display_name_plural | capitalize }} in '${selected_course.name || ''}':`"></p>
                  <ol class="mt-0">
                    <template x-for="item_name in selected_course.items" :key="item_name">
                      <li x-text="item_name"></li>
                    </template>
                  </ol>
                </div>
                <div x-show="selected_course_id && selected_course.items.length == 0"><i>No {{ table.display_name_plural }} found in this course.</i></div>
              </div>

              <div class="field is-grouped is-justify-content-flex-end">
                <div class="control">
                  <button type="submit" class="button is-link" x-bind:disabled="!selected_course_id || selected_course.items.length == 0">Copy {{ table.display_name_plural }}</button>
                </div>
                <div class="control">
                  <button type="button" class="button" @click="showCopyModal = false">Cancel</button>
                </div>
              </div>
            </form>
          </div>
        </div>
        <button type="button" class="modal-close is-large" aria-label="close" @click="showCopyModal = false"></button>
      </div>
    </span>
  </div>
</div>
{% endwith %}
